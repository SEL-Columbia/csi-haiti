<html>
	<head>
		<script src='wax/ext/leaflet.js' type='text/javascript'></script>
		<script src='wax/dist/wax.leaf.js' type='text/javascript'></script>
		<script src='ucsv-1.0.1-min.js' type='text/javascript'></script>
		<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js' type='text/javascript'></script>
		<link href='wax/ext/leaflet.css' rel='stylesheet' type='text/css' />
        <title>CSI Haiti Facilities Viewer</title>
	</head>
	<body>
		<div style='width: 100%; height: 100%;' id='map-div'></div>
        <div id='result' style="display:none"></div>
		<script>
            function buildData(array, label){
              var data = '<div style="width: 500px">&nbsp;</div>';
              data += '<table>';
              var j;
              for(j = 0; j < array.length; j++) {
                if (label[j] === 'settlements/SettlePhoto_1') {
                    data += '<img width="100%" height="100%" src="https://formhub.s3.amazonaws.com/haiti_facilities_inventory/attachments/' + array[j] + '" />'   
                } else if (array[j] !== 'n/a' && j < 10) {
                    data += "<tr>";
                    data += "<td><strong>" + label[j] + "</strong></td>";
                    data += "<td>" + array[j] + "</td>";
                    data += "</tr>";
                }
              }
              data += "</table>";
              return data;
            }             
            var url = 'http://a.tiles.mapbox.com/v3/modilabs.map-nuhzv2tu.jsonp';
            wax.tilejson(url, function(tilejson) {
                var map = new L.Map('map-div')
                .addLayer(new wax.leaf.connector(tilejson))
                .setView(new L.LatLng(18.233748078346252, -74.02795493602753), 12);
                wax.leaf.interaction(map, tilejson);
                $('#result').load('autres_points_d_infrastructure_janvier_2012_02_13.csv', function() {
                    var array = CSV.csvToArray($('#result').html());
                    var gps_col = 0;
                    for (; gps_col < array[0].length; gps_col++) {
                    if (array[0][gps_col] === 'settlements/SettleGeoCode_1')
                        break;
                    }
                    var i = 1;
                    var geo, lat, lng;
                    for (; i < array.length; i++) {
                        geo = array[i][gps_col].split(' ');
                        lat = Number(geo[0]);
                        lng = Number(geo[1]);
                        var marker = new L.Marker(new L.LatLng(lat, lng));
                        map.addLayer(marker);
                        marker.bindPopup(buildData(array[i],array[0]), { 'maxWidth': 500 }); 
                    }
                });
            });
		</script>
	</body>
</html>
